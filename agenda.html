<script>
document.addEventListener("DOMContentLoaded", async () => {

  const lista = document.getElementById("lista");
  const form = document.getElementById("agenda-form");
  const servicoSelect = document.getElementById("servico");

  // ✅ ELEMENTOS DECLARADOS EXPLICITAMENTE
  const cliente = document.getElementById("cliente");
  const servico = document.getElementById("servico");
  const dataInput = document.getElementById("data");
  const hora = document.getElementById("hora");
  const lembrete = document.getElementById("lembrete");

  // Obter usuário
  const { data: { user }, error: userError } = await supabase.auth.getUser();
  if (!user || userError) {
    location.href = "index.html";
    return;
  }

  document.getElementById("logoutBtn").onclick = async () => {
    await supabase.auth.signOut();
    location.href = "index.html";
  };

  function formatarDataHora(dataISO, hora) {
    const d = new Date(dataISO);
    return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()} às ${hora.slice(0,5)}`;
  }

  function textoLembrete(v) {
    if (!v || v == 0) return "Sem lembrete";
    return v == 24 ? "24h antes" : "2h antes";
  }

  // Carregar serviços
  async function carregarServicos() {
    const { data, error } = await supabase
      .from("servicos")
      .select("id, nome")
      .order("nome", { ascending: true });

    if (error) {
      console.error("Erro ao carregar serviços:", error);
      return;
    }

    servicoSelect.innerHTML = "<option value=''>Selecione</option>";
    data.forEach(s => {
      servicoSelect.innerHTML += `<option value="${s.id}">${s.nome}</option>`;
    });
  }

  // ✅ SALVAR AGENDAMENTO (SEM ERRO)
  form.onsubmit = async (e) => {
    e.preventDefault();

    if (!cliente.value.trim()) {
      alert("Digite o nome do cliente");
      return;
    }

    if (!servico.value) {
      alert("Selecione um serviço");
      return;
    }

    if (!dataInput.value) {
      alert("Escolha uma data");
      return;
    }

    if (!hora.value) {
      alert("Escolha uma hora");
      return;
    }

    const agendamento = {
      usuario_id: user.id,
      cliente_nome: cliente.value.trim(),
      servico_id: parseInt(servico.value),
      data_agendamento: dataInput.value,
      hora: hora.value,
      lembrete_horas: parseInt(lembrete.value) || 0,
      status: "pendente"
    };

    const { error } = await supabase
      .from("agendamentos")
      .insert([agendamento]);

    if (error) {
      console.error("Erro ao salvar agendamento:", error);
      alert("Erro ao salvar agendamento.");
      return;
    }

    form.reset();
    carregarAgenda();
  };

  // Carregar agenda
  async function carregarAgenda() {
    lista.innerHTML = "";

    const { data, error } = await supabase
      .from("agendamentos")
      .select("*")
      .eq("usuario_id", user.id)
      .order("data_agendamento", { ascending: true });

    if (error) {
      console.error("Erro ao carregar agenda:", error);
      return;
    }

    data.forEach(a => {
      lista.innerHTML += `
        <li data-id="${a.id}" data-status="${a.status}">
          <strong>${a.cliente_nome}</strong>
          <small>${formatarDataHora(a.data_agendamento, a.hora)}</small>
          <small>Lembrete: ${textoLembrete(a.lembrete_horas)}</small>
        </li>
      `;
    });
  }

  await carregarServicos();
  await carregarAgenda();
});
</script>
