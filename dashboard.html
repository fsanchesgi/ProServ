<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - ProServ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" href="./images/favicon.png">
  <link rel="stylesheet" href="./style.css">

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./auth-guard.js"></script>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="container">
    <div style="display:flex; align-items:center;">
      <img src="./images/logo.png" alt="ProServ Logo">
    </div>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="planos.html">Planos</a>
      <a href="#" id="logoutBtn" class="button">Sair</a>
    </nav>
  </div>
</header>

<!-- HERO -->
<section class="hero-bg">
  <div class="hero-content">
    <h1 id="welcome">Dashboard</h1>
    <p id="userPlan">Carregando informa√ß√µes...</p>
  </div>
</section>

<!-- CONTE√öDO -->
<section style="max-width:1200px; margin:auto; padding:3rem 1rem;">

  <!-- ADMIN -->
  <div id="adminArea" style="display:none;">
    <h2>üìä Painel Administrativo</h2>
    <div class="cards cards-3">
      <div class="card">
        <h3>Usu√°rios</h3>
        <p>Gerenciar usu√°rios cadastrados</p>
      </div>
      <div class="card">
        <h3>Planos</h3>
        <p>Gerenciar planos do sistema</p>
      </div>
      <div class="card">
        <h3>Financeiro</h3>
        <p>Pagamentos e assinaturas</p>
      </div>
    </div>
  </div>

  <!-- USU√ÅRIO -->
  <div id="userArea" style="display:none;">
    <h2>üìÖ Sua Agenda</h2>
    <div id="agendaList" class="cards cards-3"></div>

    <div id="limitWarning" style="display:none; margin-top:2rem; color:#dc2626; font-weight:600;">
      ‚ö†Ô∏è Limite de agendamentos do seu plano atingido.
    </div>

    <div style="margin-top:2rem;">
      <button id="newAgendamento" class="plan-button">Novo Agendamento</button>
    </div>
  </div>

</section>

<!-- FOOTER -->
<footer style="background: linear-gradient(90deg, #1f2937, #111827); color: #fff; padding: 3rem 2rem;">
  <div style="text-align:center; color:#9ca3af;">
    &copy; 2025 ProServ. Todos os direitos reservados.
  </div>
</footer>

<!-- SCRIPT -->
<script>
const supabase = Supabase.createClient(
  'https://uqwbduinwugaqexsvkxc.supabase.co',
  'SUA_ANON_KEY_AQUI'
);

async function loadDashboard() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    window.location.href = 'login.html';
    return;
  }

  // Perfil
  const { data: profile } = await supabase
    .from('profiles')
    .select('nome, role, plano_id, planos(nome, limite_agendamentos)')
    .eq('id', user.id)
    .single();

  document.getElementById('welcome').innerText = `Ol√°, ${profile.nome}`;
  document.getElementById('userPlan').innerText =
    profile.planos ? `Plano ativo: ${profile.planos.nome}` : 'Sem plano ativo';

  // ADMIN
  if (profile.role === 'admin') {
    document.getElementById('adminArea').style.display = 'block';
    return;
  }

  // USU√ÅRIO
  document.getElementById('userArea').style.display = 'block';

  const { data: agendamentos } = await supabase
    .from('agendamentos')
    .select('*')
    .eq('usuario_id', user.id)
    .order('data_agendamento');

  const agendaDiv = document.getElementById('agendaList');
  agendaDiv.innerHTML = '';

  agendamentos.forEach(a => {
    agendaDiv.innerHTML += `
      <div class="card">
        <h3>${a.cliente_nome}</h3>
        <p>${new Date(a.data_agendamento).toLocaleString()}</p>
        <p>Status: ${a.status}</p>
      </div>
    `;
  });

  // Limite de plano
  if (
    profile.planos &&
    profile.planos.limite_agendamentos &&
    agendamentos.length >= profile.planos.limite_agendamentos
  ) {
    document.getElementById('limitWarning').style.display = 'block';
    document.getElementById('newAgendamento').disabled = true;
  }
}

// Logout
document.getElementById('logoutBtn').onclick = async () => {
  await supabase.auth.signOut();
  window.location.href = 'index.html';
};

loadDashboard();
</script>

</body>
</html>
