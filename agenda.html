<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>ProServ | Agenda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./style.css">
</head>

<body>

<header>
  <div class="container">
    <img src="./images/logo.png" height="70">
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="agenda.html" class="active">Agenda</a>
      <button id="logoutBtn">Sair</button>
    </nav>
  </div>
</header>

<section class="dashboard-page">

  <div class="cards-grid">

    <!-- FORM -->
    <div class="dashboard-card">
      <h3 id="form-title">Novo Atendimento</h3>

      <form id="agenda-form">
        <input type="hidden" id="agenda_id">

        <label>Cliente</label>
        <input id="cliente" required>

        <label>Serviço</label>
        <select id="servico" required></select>

        <label>Data</label>
        <input type="date" id="data" required>

        <label>Hora</label>
        <input type="time" id="hora" required>

        <label>Lembrete</label>
        <select id="lembrete">
          <option value="">Sem lembrete</option>
          <option value="15">15 minutos</option>
          <option value="30">30 minutos</option>
          <option value="60">1 hora</option>
        </select>

        <br><br>
        <button type="submit">Salvar</button>
        <p id="msg"></p>
      </form>
    </div>

    <!-- LISTA -->
    <div class="dashboard-card">
      <h3>Atendimentos</h3>
      <ul id="lista-agenda" class="agenda-list"></ul>
    </div>

  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./supabase.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const form = document.getElementById("agenda-form");
  const lista = document.getElementById("lista-agenda");
  const agendaId = document.getElementById("agenda_id");
  const msg = document.getElementById("msg");

  const { data: auth } = await supabase.auth.getUser();
  if (!auth.user) {
    location.href = "index.html";
    return;
  }
  const user = auth.user;

  logoutBtn.onclick = async () => {
    await supabase.auth.signOut();
    location.href = "index.html";
  };

  // SERVIÇOS
  const { data: servicos } = await supabase
    .from("servicos")
    .select("*")
    .eq("user_id", user.id);

  servicos.forEach(s => {
    servico.innerHTML += `<option value="${s.id}">${s.nome}</option>`;
  });

  // SALVAR / ATUALIZAR
  form.onsubmit = async e => {
    e.preventDefault();

    const payload = {
      usuario_id: user.id,
      cliente_nome: cliente.value,
      servico_id: servico.value,
      data_agendamento: data.value,
      hora: hora.value,
      lembrete_minutos: lembrete.value || null,
      status: "pendente"
    };

    let error;
    if (agendaId.value) {
      ({ error } = await supabase
        .from("agendamentos")
        .update(payload)
        .eq("id", agendaId.value));
    } else {
      ({ error } = await supabase.from("agendamentos").insert([payload]));
    }

    if (!error) {
      form.reset();
      agendaId.value = "";
      carregarAgenda();
    } else {
      console.error(error);
      msg.textContent = "Erro ao salvar.";
    }
  };

  // EDITAR
  window.editarAgendamento = async id => {
    const { data } = await supabase
      .from("agendamentos")
      .select("*")
      .eq("id", id)
      .single();

    agendaId.value = data.id;
    cliente.value = data.cliente_nome;
    servico.value = data.servico_id;
    data.value = data.data_agendamento;
    hora.value = data.hora;
    lembrete.value = data.lembrete_minutos || "";
  };

  // EXCLUIR
  window.excluirAgendamento = async id => {
    if (confirm("Excluir atendimento?")) {
      await supabase.from("agendamentos").delete().eq("id", id);
      carregarAgenda();
    }
  };

  async function carregarAgenda() {
    lista.innerHTML = "";

    const { data } = await supabase
      .from("agendamentos")
      .select("*")
      .eq("usuario_id", user.id)
      .order("data_agendamento");

    data.forEach(a => {
      lista.innerHTML += `
        <li>
          <div>
            <strong>${a.cliente_nome}</strong><br>
            ${a.data_agendamento} ${a.hora}
          </div>
          <div>
            <button onclick="editarAgendamento('${a.id}')">Alterar</button>
            <button onclick="excluirAgendamento('${a.id}')">Excluir</button>
          </div>
        </li>`;
    });
  }

  carregarAgenda();
});
</script>

</body>
</html>
