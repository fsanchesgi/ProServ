<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>ProServ | Gest√£o de Servi√ßos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./style.css">
</head>
<body>

<header>
  <div class="container">
    <img src="./images/logo.png" alt="ProServ Logo" style="max-height:50px;">
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="agenda.html">Agenda</a>
      <a href="servicos.html" class="active">Servi√ßos</a>
      <button id="logoutBtn">Sair</button>
    </nav>
  </div>
</header>

<section class="dashboard-page">
  <div class="container">

    <div class="dashboard-header">
      <h1>üõ† Gest√£o de Servi√ßos</h1>
      <p>Cadastre, edite ou exclua servi√ßos facilmente</p>
    </div>

    <!-- Card: Novo Servi√ßo -->
    <div class="dashboard-card">
      <h3>Novo Servi√ßo</h3>
      <form id="servico-form">
        <div class="form-group">
          <label>Nome do Servi√ßo</label>
          <input type="text" id="nome" required>
        </div>
        <div class="form-group">
          <label>Dura√ß√£o (minutos)</label>
          <input type="number" id="duracao" min="1" required>
        </div>
        <div class="form-group">
          <label>Valor (R$)</label>
          <input type="number" id="valor" min="0" step="0.01" required>
        </div>
        <div class="form-group">
          <label>Categoria</label>
          <input type="text" id="categoria">
        </div>
        <div class="form-group">
          <label>Promo√ß√£o ativa?</label>
          <input type="checkbox" id="promo_ativa">
        </div>
        <div class="form-group">
          <label>Valor Promocional (R$)</label>
          <input type="number" id="valor_promocional" min="0" step="0.01">
        </div>
        <button class="plan-button" type="submit">Salvar Servi√ßo</button>
      </form>
      <p id="msg-servico"></p>
    </div>

    <!-- Card: Lista de Servi√ßos -->
    <div class="dashboard-card">
      <h3>Servi√ßos Cadastrados</h3>
      <div class="form-group">
        <label>Filtrar por Categoria</label>
        <input type="text" id="filtro-categoria" placeholder="Digite a categoria">
      </div>
      <ul id="lista-servicos" class="agenda-list"></ul>
    </div>

  </div>
</section>

<footer style="background:#111827; color:#9ca3af; text-align:center; padding:2rem;">
  &copy; 2025 ProServ
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="./supabase.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const form = document.getElementById("servico-form");
  const msg = document.getElementById("msg-servico");
  const lista = document.getElementById("lista-servicos");
  const filtroCategoria = document.getElementById("filtro-categoria");

  // LOGOUT
  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await supabase.auth.signOut();
    window.location.href = "index.html";
  });

  // USU√ÅRIO LOGADO
  const { data: authData, error: authError } = await supabase.auth.getUser();
  if (authError || !authData.user) {
    console.error("Usu√°rio n√£o autenticado");
    return;
  }
  const user = authData.user;

  // FUN√á√ÉO: CARREGAR SERVI√áOS
  async function carregarServicos(filtro = "") {
    lista.innerHTML = "";
    let query = supabase.from("servicos").select("*").eq("user_id", user.id);
    if (filtro.trim()) query = query.ilike("categoria", `%${filtro}%`);
    const { data: servicos, error } = await query.order("nome");
    if (error) return console.error("Erro ao carregar servi√ßos:", error);

    servicos.forEach(s => {
      const li = document.createElement("li");
      li.innerHTML = `
        <strong>${s.nome}</strong> (${s.duracao_minutos} min) - R$ ${s.valor}
        ${s.promo_ativa ? ` | Promo: R$ ${s.valor_promocional}` : ""}
        <br>Categoria: ${s.categoria || "-"}
        <div class="btn-group">
          <button onclick="editarServico('${s.id}')">Editar</button>
          <button onclick="excluirServico('${s.id}')">Excluir</button>
        </div>
      `;
      lista.appendChild(li);
    });
  }

  // FILTRO POR CATEGORIA
  filtroCategoria.addEventListener("input", () => {
    carregarServicos(filtroCategoria.value);
  });

  // SALVAR NOVO SERVI√áO
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.textContent = "";

    const nome = document.getElementById("nome").value.trim();
    const duracao_minutos = Number(document.getElementById("duracao").value);
    const valor = Number(document.getElementById("valor").value);
    const categoria = document.getElementById("categoria").value.trim();
    const promo_ativa = document.getElementById("promo_ativa").checked;
    const valor_promocional = Number(document.getElementById("valor_promocional").value || 0);

    try {
      const { error } = await supabase.from("servicos").insert([{
        user_id: user.id,
        nome,
        duracao_minutos,
        valor,
        categoria,
        promo_ativa,
        valor_promocional
      }]);
      if (error) throw error;

      msg.textContent = "Servi√ßo cadastrado com sucesso!";
      msg.style.color = "green";
      form.reset();
      carregarServicos();

    } catch (err) {
      console.error("Erro ao salvar servi√ßo:", err);
      msg.textContent = "Erro ao salvar servi√ßo.";
      msg.style.color = "red";
    }
  });

  // FUN√á√ÉO GLOBAL: EXCLUIR SERVI√áO
  window.excluirServico = async (id) => {
    if (!confirm("Deseja realmente excluir este servi√ßo?")) return;
    const { error } = await supabase.from("servicos").delete().eq("id", id).eq("user_id", user.id);
    if (error) return console.error("Erro ao excluir servi√ßo:", error);
    carregarServicos();
  }

  // FUN√á√ÉO GLOBAL: EDITAR SERVI√áO
  window.editarServico = async (id) => {
    const { data, error } = await supabase.from("servicos").select("*").eq("id", id).single();
    if (error) return console.error("Erro ao buscar servi√ßo:", error);

    document.getElementById("nome").value = data.nome;
    document.getElementById("duracao").value = data.duracao_minutos;
    document.getElementById("valor").value = data.valor;
    document.getElementById("categoria").value = data.categoria || "";
    document.getElementById("promo_ativa").checked = data.promo_ativa;
    document.getElementById("valor_promocional").value = data.valor_promocional || 0;

    // Alterar submit para atualizar servi√ßo
    form.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = "";
      try {
        const { error } = await supabase.from("servicos").update({
          nome: document.getElementById("nome").value.trim(),
          duracao_minutos: Number(document.getElementById("duracao").value),
          valor: Number(document.getElementById("valor").value),
          categoria: document.getElementById("categoria").value.trim(),
          promo_ativa: document.getElementById("promo_ativa").checked,
          valor_promocional: Number(document.getElementById("valor_promocional").value || 0)
        }).eq("id", id).eq("user_id", user.id);

        if (error) throw error;
        msg.textContent = "Servi√ßo atualizado com sucesso!";
        msg.style.color = "green";
        form.reset();
        form.onsubmit = salvarServicoOriginal;
        carregarServicos();

      } catch (err) {
        console.error("Erro ao atualizar servi√ßo:", err);
        msg.textContent = "Erro ao atualizar servi√ßo.";
        msg.style.color = "red";
      }
    }
  }

  // Salvar servi√ßo original (novo)
  const salvarServicoOriginal = form.onsubmit;

  // Carregar inicialmente
  carregarServicos();
});
</script>

</body>
</html>
