<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>ProServ | Agenda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" href="./images/favicon.png">
  <link rel="stylesheet" href="./style.css">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header class="header">
  <div class="container">
    <h1>ðŸ“… Agenda</h1>
    <p>Gerencie seus atendimentos</p>
  </div>
</header>

<main class="container">

  <!-- FILTRO (NÃƒO ALTERADO) -->
  <div class="filter-box">
    <input type="text" id="filtro" placeholder="Pesquisar cliente ou serviÃ§o">
  </div>

  <!-- LISTA -->
  <div id="lista-agendamentos" class="agenda-list"></div>

</main>

<!-- MODAL EDITAR -->
<div id="modal-editar" class="modal hidden">
  <div class="modal-content">
    <h3>Editar Agendamento</h3>

    <input type="date" id="edit-data">
    <input type="time" id="edit-hora">
    <input type="number" id="edit-valor" placeholder="Valor">

    <button onclick="salvarEdicao()">Salvar</button>
    <button class="cancel" onclick="fecharModal()">Cancelar</button>
  </div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://uqwbduinwugaqexsvkxc.supabase.co",
  "SUA_ANON_KEY_AQUI"
);

let agendamentos = [];
let agendamentoEditando = null;

/* =========================
   CARREGAR AGENDA
========================= */
async function carregarAgenda() {
  const { data, error } = await supabase
    .from("agenda")
    .select("*")
    .order("data", { ascending: true });

  if (error) {
    console.error(error);
    return;
  }

  agendamentos = data;
  renderizarAgenda(data);
}

/* =========================
   RENDERIZAR
========================= */
function renderizarAgenda(lista) {
  const container = document.getElementById("lista-agendamentos");
  container.innerHTML = "";

  lista.forEach(item => {
    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      <strong>${item.cliente}</strong>
      <p>${item.servico}</p>
      <p>${item.data} Ã s ${item.hora}</p>
      <p>Status: <b>${item.status}</b></p>

      <div class="actions">
        <button onclick="finalizarAgendamento('${item.id}')">Finalizar</button>
        <button onclick="editarAgendamento('${item.id}')">Editar</button>
      </div>
    `;

    container.appendChild(div);
  });
}

/* =========================
   FINALIZAR
========================= */
async function finalizarAgendamento(id) {
  const { error } = await supabase
    .from("agenda")
    .update({ status: "finalizado" })
    .eq("id", id);

  if (error) {
    alert("Erro ao finalizar");
    console.error(error);
    return;
  }

  await supabase
    .from("financeiro")
    .update({ status: "pago" })
    .eq("agenda_id", id);

  carregarAgenda();
}

/* =========================
   EDITAR
========================= */
function editarAgendamento(id) {
  agendamentoEditando = agendamentos.find(a => a.id === id);

  document.getElementById("edit-data").value = agendamentoEditando.data;
  document.getElementById("edit-hora").value = agendamentoEditando.hora;
  document.getElementById("edit-valor").value = agendamentoEditando.valor;

  document.getElementById("modal-editar").classList.remove("hidden");
}

function fecharModal() {
  document.getElementById("modal-editar").classList.add("hidden");
}

async function salvarEdicao() {
  const data = document.getElementById("edit-data").value;
  const hora = document.getElementById("edit-hora").value;
  const valor = document.getElementById("edit-valor").value;

  const { error } = await supabase
    .from("agenda")
    .update({ data, hora, valor })
    .eq("id", agendamentoEditando.id);

  if (error) {
    alert("Erro ao editar");
    console.error(error);
    return;
  }

  fecharModal();
  carregarAgenda();
}

/* =========================
   FILTRO (IMUTÃVEL)
========================= */
document.getElementById("filtro").addEventListener("input", e => {
  const termo = e.target.value.toLowerCase();

  const filtrados = agendamentos.filter(a =>
    a.cliente.toLowerCase().includes(termo) ||
    a.servico.toLowerCase().includes(termo)
  );

  renderizarAgenda(filtrados);
});

carregarAgenda();
</script>

</body>
</html>
