<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ProServ | Agenda</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="./style.css">

<style>
/* VISUAL PRESERVADO â€“ NÃƒO ALTERADO */
body { font-family: Inter, sans-serif; background:#f9fafb; margin:0; color:#111827 }
header { background:#111827; padding:1rem 0; position:sticky; top:0; z-index:1000 }
header .container { padding:0 2rem; display:flex; justify-content:space-between; align-items:center }
header nav a { color:#fff; margin-right:1.5rem; text-decoration:none }
header nav a.active { border-bottom:2px solid #4f46e5 }
header nav button { background:#4f46e5; border:none; color:#fff; padding:.5rem 1rem; border-radius:6px }

.dashboard-page { max-width:1200px; margin:2.5rem auto; padding:0 2rem }
.cards-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:2rem }
.dashboard-card { background:#fff; padding:1.5rem; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.05) }

.form-group { margin-bottom:1rem }
label { font-weight:500; display:block; margin-bottom:.25rem }
input, select { width:100%; padding:.5rem; border-radius:6px; border:1px solid #d1d5db }

.btn-primary { background:#4f46e5; color:#fff; border:none; padding:.6rem 1.2rem; border-radius:8px }
.agenda-list { list-style:none; padding:0 }
.agenda-list li { background:#f3f4f6; border-radius:8px; padding:.75rem; margin-bottom:.75rem; display:flex; justify-content:space-between }

.actions button { margin-left:.4rem; border:none; padding:.4rem .7rem; border-radius:6px; font-size:.85rem }
.btn-finalizar { background:#10b981; color:#fff }
.btn-excluir { background:#ef4444; color:#fff }
.btn-editar { background:#f59e0b; color:#fff }
</style>
</head>

<body>

<header>
<div class="container">
<img src="./images/logo.png" height="70">
<nav>
<a href="dashboard.html">Dashboard</a>
<a href="agenda.html" class="active">Agenda</a>
<button id="logoutBtn">Sair</button>
</nav>
</div>
</header>

<section class="dashboard-page">
<div class="cards-grid">

<div class="dashboard-card">
<h3>Novo Atendimento</h3>

<form id="agenda-form">
<input type="hidden" id="agenda-id">

<div class="form-group">
<label>Cliente</label>
<input id="cliente" required>
</div>

<div class="form-group">
<label>ServiÃ§o</label>
<select id="servico" required></select>
</div>

<div class="form-group">
<label>Data</label>
<input type="date" id="data" required>
</div>

<div class="form-group">
<label>Hora</label>
<input type="time" id="hora" required>
</div>

<div class="form-group">
<label>Lembrete</label>
<select id="lembrete">
<option value="0">Sem lembrete</option>
<option value="24">24 horas antes</option>
<option value="2">2 horas antes</option>
</select>
</div>

<button class="btn-primary">Salvar</button>
<p id="msg"></p>
</form>
</div>

<div class="dashboard-card">
<h3>Atendimentos</h3>
<ul id="lista-agenda" class="agenda-list"></ul>
</div>

</div>
</section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ðŸ”’ SUPABASE EMBUTIDO â€” EVITA 404 */
const supabase = supabaseJs.createClient(
  "https://uqwbduinwugaqexsvkxc.supabase.co",
  "SUA_ANON_KEY_AQUI"
)
</script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

const { data: auth } = await supabase.auth.getUser()
if (!auth.user) return location.href = "index.html"
const user = auth.user

logoutBtn.onclick = async () => {
await supabase.auth.signOut()
location.href = "index.html"
}

const servicoSelect = document.getElementById("servico")
const lista = document.getElementById("lista-agenda")
const form = document.getElementById("agenda-form")

/* âœ… DROPDOWN â€“ FUNCIONANDO */
const { data: servicos } = await supabase
.from("servicos")
.select("*")
.eq("user_id", user.id)

servicoSelect.innerHTML = `<option value="">Selecione</option>`
servicos?.forEach(s => {
servicoSelect.innerHTML += `<option value="${s.id}" data-valor="${s.valor}">${s.nome}</option>`
})

/* RESTANTE DO FLUXO MANTIDO */
async function carregarAgenda() {
lista.innerHTML = ""
const { data } = await supabase
.from("agendamentos")
.select("*")
.eq("usuario_id", user.id)
.order("data_agendamento")

data?.forEach(a => {
lista.innerHTML += `
<li>
<div>
<strong>${a.cliente_nome}</strong><br>
${a.data_agendamento} ${a.hora}
</div>
<div class="actions">
<button class="btn-editar" onclick='editarAgendamento(${JSON.stringify(a)})'>Editar</button>
<button class="btn-excluir" onclick="excluirAgendamento('${a.id}')">Excluir</button>
</div>
</li>`
})
}

window.editarAgendamento = a => {
if (a.status === "finalizado") return alert("Agendamento finalizado nÃ£o pode ser editado.")
agenda-id.value = a.id
cliente.value = a.cliente_nome
servico.value = a.servico_id
data.value = a.data_agendamento
hora.value = a.hora
lembrete.value = a.lembrete_horas || 0
}

window.excluirAgendamento = async id => {
if (confirm("Excluir atendimento?")) {
await supabase.from("agendamentos").delete().eq("id", id)
carregarAgenda()
}
}

form.onsubmit = async e => {
e.preventDefault()
const opt = servicoSelect.selectedOptions[0]

await supabase.from("agendamentos").insert({
usuario_id: user.id,
cliente_nome: cliente.value,
servico_id: servico.value,
data_agendamento: data.value,
hora: hora.value,
lembrete_horas: lembrete.value,
valor: opt.dataset.valor,
status: "pendente"
})

form.reset()
carregarAgenda()
}

carregarAgenda()
})
</script>

</body>
</html>
